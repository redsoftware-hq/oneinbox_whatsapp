<script setup>
import { getCurrentInstance, ref, watch, nextTick, onMounted, onBeforeUnmount, computed, h } from 'vue';
import WhatsAppArea from './WhatsAppArea.vue';
import WhatsAppBox from './WhatsAppBox.vue';
import { createResource } from 'frappe-ui';
import WhatsAppIcon from './components/Icons/WhatsAppIcon.vue';
import WhatsappTemplateSelectorModal from './components/WhatsappTemplateSelectorModal.vue';
import WhatsappSidebar from './WhatsappSidebar.vue';
import WhatappAddToLeadModal from './components/WhatappAddToLeadModal.vue';
import {Button} from "frappe-ui"

const app = getCurrentInstance();
const { $socket } = app.appContext.config.globalProperties;

const props = defineProps({
  doctype: String,
  docname: String,
  phone: String,
  to: String,
  document: {
    type: Object,
    default: () => ({}) // Provide default structure
  }
});

const selectedPhone = ref('');
const showWhatsappTemplates = ref(false);
const showAddLeadModal = ref(false);


function updatePhoneNumber(newPhone, newName) {
  selectedPhone.value = newPhone;
}

function sendTemplate(template) {
  showWhatsappTemplates.value = false;
  try {
    createResource({
      url: "frappe_whatsapp.api.whatsapp.send_whatsapp_template",
      params: {
        reference_doctype: props.doctype,
        reference_name: props.docname,
        to: props.phone,
        template,
      },
      auto: true,
      headers: {
        'X-Frappe-CSRF-Token': frappe.csrf_token
      }
    }).then(() => {
      console.log('Template sent successfully!');
    });
  } catch (error) {
    console.error('Error sending template:', error);
  }
}

const whatsappMessages = computed(() =>
  createResource({
    url: '',
    cache: ['whatsapp_messages', selectedPhone.value],
    params: {
      phone: selectedPhone.value || ""
    },
    auto: true,
    transform: (data) => data.sort((a, b) => new Date(a.creation) - new Date(b.creation)),
  })
);

function scrollToBottom() {
  nextTick(() => {
    const el = document.querySelector('.messages-container');
    if (el) el.scrollTop = el.scrollHeight;
  });
}

watch(whatsappMessages.value.data, scrollToBottom);

// WebSocket updates
onMounted(() => {
  $socket.on('whatsapp_message', (data) => {
    if (
      (data.reference_doctype === props.doctype && data.reference_name === props.docname) ||
      data.from === selectedPhone.value ||
      data.to === selectedPhone.value
    ) {
      whatsappMessages.value.reload();
    }
  });
});

onBeforeUnmount(() => {
  $socket.off('whatsapp_message');
});
</script>

<template>
    <div class="flex h-4/5 flex-col overflow-hidden">
    <div class="top-bar flex  p-3 bg-white"  >
        <div class="flex column gap-5 w-full">
          <button class="text-2xl" @click="window.history.back()">‚Üê</button>
         <div class="flex gap-2 items-center">
           <WhatsAppIcon class="h-8 w-8 text-gray-500" />
           <h1>Whatsapp</h1>
         </div>
        </div>
      </div>
    <div class="flex h-screen overflow-hidden" >
    <div class="w-1/5">
      <WhatsappSidebar @contact-selected="updatePhoneNumber" />
    </div>
    
    <div class="whatsapp-chat-container h-screen w-full flex-col" >
      <div class="top-bar flex items-center justify-between p-2 bg-white" v-if="selectedPhone" >
        <div class="flex flex-col">
          <h2 class="text-xl font-semibold text-gray-800">{{ selectedPhone.number || '' }}</h2>
          <h2 class="text-sm font-semibold text-gray-800">{{ selectedPhone.name || '' }}</h2>
        </div>
        <div class="flex items-center space-x-4">
          <Button
    :variant="'solid'"
    :ref_for="true"
    theme="gray"
    size="sm"
    label="Button"
    :loading="false"
    :loadingText="null"
    :disabled="false"
    :link="null"
    @click="showAddLeadModal = true"
  >
            + Add Lead
          </button>
          
          <Button
        label="Send Template"
        class="send-template-btn text-lg"
        @click="showWhatsappTemplates = true"
      />

        </div>
      </div>
      
      <div
  v-if="!selectedPhone"
  class="flex flex-1 flex-col items-center justify-center gap-3 text-xl font-medium text-gray-500"
>
  <!-- <WhatsAppIcon class="h-10 w-10 text-gray-500" /> -->
  <span>Click Any Contact To View Conversation</span>
</div>

<div
  v-else-if="selectedPhone && !whatsappMessages.data?.length"
  class="flex flex-1 flex-col items-center justify-center gap-3 text-xl font-medium text-gray-500"
>
  <WhatsAppIcon class="h-10 w-10 text-gray-500" />
  <span>No messages yet</span>
</div>

<div v-else class="messages-container flex-1 p-4 overflow-y-auto">
  <WhatsAppArea class="px-3 sm:px-10" v-model:reply="reply" :messages="whatsappMessages.data" />
</div>


      <div class="chat-box-container border-t-gray-100 mb-4">
        <WhatsAppBox
          ref="whatsappBox"
          v-model:doc="props.document"
          v-model:reply="reply"
          :doctype="props.doctype"
          :docname="props.docname"
          :phone="props.phone"
          @message-sent="whatsappMessages.reload"
          v-if="selectedPhone"
        />
      </div>

      <WhatsappTemplateSelectorModal
        v-model="showWhatsappTemplates"
        :doctype="doctype"
        @send="(t) => sendTemplate(t)"
      />

      <WhatappAddToLeadModal 
      v-model="showAddLeadModal" 
      :first_name="selectedPhone.name || ''"
      :contact_number="selectedPhone.number || ''"
      />


    </div>
  </div>
</div>
</template>

<style>
.whatsapp-chat-container {
  display: flex;
  flex-direction: column;
  height: calc(95vh);
  max-height: 100%;
  background-color: #f0f2f5;
}

.top-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #e0e0e0;
}

.send-template-btn {
  background-color: #bababa;
  padding: 6px 14px;
  border-radius: 6px;
  transition: background-color 0.3s ease;
}

.send-template-btn:hover {
  background-color: #999999;
}

.messages-container {
  overflow-y: hidden;
}
.chat-box-container{
  margin-bottom:2rem;
  padding:3rem

}
*{
  overflow: hidden;
}
</style>
